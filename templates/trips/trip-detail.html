{% extends "base.html" %}
{% load partials %}
{% block page_title %}
    {{ trip.title }}
{% endblock page_title %}
{% block content %}
    <!-- Details Section -->
    <section id="details" class="text-center md:text-start">
        <div class="w-full px-6 py-4 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
            <div class="md:flex items-center mb-3">
                <h2 class="text-4xl font-semibold tracking-tight md:mr-6 mb-2">{{ trip.title }}</h2>
                <span class="badge badge-ghost">{{ trip.get_status_display }}</span>
            </div>
            <div id="trip-details" class="mb-4">
                {% if trip.start_date and trip.end_date %}
                    <span>Start Date: <strong>{{ trip.start_date }}</strong> / End date: <strong>{{ trip.end_date }}</strong></span>
                {% else %}
                    <span>Start Date: <strong>-</strong>  /  End date: <strong>-</strong></span>
                {% endif %}
            </div>
            <p>
                <em>{{ trip.description }}</em>
            </p>
            <div x-data id="buttons" class="my-6">
                <button class="btn btn-sm btn-primary mr-3"
                        hx-get="{% url 'trips:trip-add-link' trip.id %}"
                        hx-target="#dialog"
                        hx-swap="innerHTML"
                        @click="$dispatch('open-modal')">Add a link</button>
                <button class="btn btn-sm btn-primary mr-3"
                        hx-get="{% url 'trips:trip-add-place' trip.id %}"
                        hx-target="#dialog"
                        hx-swap="innerHTML"
                        @click="$dispatch('open-modal')">Add a place</button>
                <button class="btn btn-sm btn-primary mr-3"
                        hx-get="{% url 'trips:trip-add-note' trip.id %}"
                        hx-target="#dialog"
                        hx-swap="innerHTML"
                        @click="$dispatch('open-modal')">Add a note</button>
            </div>
        </div>
    </section>
    <hr>
    <!-- Links Section -->
    <section id="links" class="mt-6 mb-4 px-4">
        <div x-data class="flex items-center mb-8">
            <h3 class="text-2xl font-bold mr-4 grow">Links</h3>
            <button class="btn btn-sm btn-primary mr-3"
                    hx-get="{% url 'trips:trip-add-link' trip.id %}"
                    hx-target="#dialog"
                    hx-swap="innerHTML"
                    @click="$dispatch('open-modal')">Add a link</button>
        </div>
        {% partialdef link-list inline=true %}
        <ul class="my-3 columns-2"
            hx-swap="outerHTML"
            hx-get="{% url 'trips:link-list' trip.id %}"
            hx-trigger="linkSaved from:body">
            {% for link in trip.links.all %}
                <li x-data class="flex mb-3 pb-2">
                    <a href="{{ link.url }}" class="grow">
                        {% if link.title %}
                            {{ link.title }}
                        {% else %}
                            {{ link.url }}
                        {% endif %}
                    </a>
                    <button class="btn btn-sm btn-primary-outline ms-2"
                            hx-get="{% url 'trips:link-update' link.id %}"
                            hx-target="#dialog"
                            hx-swap="innerHTML"
                            @click="$dispatch('open-modal')">
                        {% heroicon_outline "pencil" stroke_width=2 class="size-4" %}
                    </button>
                    <button class="btn btn-sm btn-danger-outline ms-2"
                            hx-delete="{% url 'trips:link-delete' link.pk %}"
                            hx-confirm="Are you sure you want to delete {{ link.url }}">
                        {% heroicon_outline "x-mark" stroke_width=2 class="size-4" %}
                    </button>
                </li>
            {% endfor %}
        </ul>
        {% if request.htmx %}
            <div hx-swap-oob="innerHTML:#messages">{% include 'includes/messages.html' %}</div>
        {% else %}
        {% endif %}
    {% endpartialdef %}
</section>
<hr>
<!-- Places Section -->
<section id="places" class="mt-6 mb-4 px-4">
    {% partialdef place-list inline=true %}
    <div id="place-control" class="flex items-center mb-8" hx-swap-oob=true>
        <h3 class="text-2xl font-bold mr-4 grow">Places</h3>
        {% if trip.places.all %}
            <button class="btn btn-sm btn-primary-outline text-center inline-flex items-center"
                    hx-get="{% url 'trips:map' trip.id %}"
                    hx-target="#place-list"
                    hx-swap="innerHTML">
                {% heroicon_outline "map" stroke_width=2 class="size-4 me-2" %}Map view
            </button>
        {% endif %}
        <button class="btn btn-sm btn-primary"
                hx-get="{% url 'trips:trip-add-place' trip.id %}"
                hx-target="#dialog"
                hx-swap="innerHTML"
                @click="$dispatch('open-modal')">Add a Place</button>
    </div>
    {% if trip.places.all %}
        <div id="place-list"
             hx-swap="outerHTML"
             hx-get="{% url 'trips:place-list' trip.id %}"
             hx-trigger="placeSaved from:body"
             hx-target="#place-list">
            <div x-data="{ active: 1 }">
                <ul class="mb-4">
                    {% for day in trip.days.all %}
                        {% include "trips/includes/places-single-day.html" %}
                    {% endfor %}
                </ul>
                {% if not_assigned_locations.all %}
                    <div x-data class="px-4 mb-2">
                        <h4 class="text-xl font-semibold mb-3">Places not assigned</h4>
                        <ul class="flex flex-wrap items-center justify-start">
                            {% for place in not_assigned_locations %}
                                <li class="me-4 mb-2 bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300 border border-green-400 cursor-pointer">
                                    <a href="#"
                                       hx-get="{% url 'trips:place-assign' place.id %}"
                                       hx-target="#dialog"
                                       hx-swap="innerHTML"
                                       @click="$dispatch('open-modal')">{{ place.name }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
            {% if request.htmx %}
                <div hx-swap-oob=innerHTML:#messages>{% include "includes/messages.html" %}</div>
            {% else %}
            {% endif %}
        {% else %}
            <p class="mb-5 text-gray-500">No places here. Add your first place where you want to go...</p>
        {% endif %}
    {% endpartialdef %}
</section>
<hr>
<!-- Notes Section -->
<section id="notes" class="mt-6 mb-4 px-4">
    <div x-data class="flex items-center mb-8">
        <h3 class="text-2xl font-bold mr-4 grow">Notes</h3>
        <button class="btn btn-sm btn-primary"
                hx-get="{% url 'trips:trip-add-note' trip.id %}"
                hx-target="#dialog"
                hx-swap="innerHTML"
                @click="$dispatch('open-modal')">Add a Note</button>
    </div>
    {% partialdef note-list inline=true %}
    <ul id="notes-list"
        class="my-3"
        hx-swap="outerHTML"
        hx-get="{% url 'trips:note-list' trip.id %}"
        hx-trigger="noteSaved from:body">
        {% for note in trip.notes.all %}
            <li x-data class="flex border-b border-gray-200 mb-3 pb-2 items-center">
                <span class="grow truncate">{{ note.content }}</span>
                {% if note.checked == True %}
                    <button class="btn btn-xs btn-danger-outline ms-2"
                            hx-post="{% url 'trips:note-check' note.id %}"
                            hx-target="#dialog"
                            hx-swap="innerHTML">
                        {% heroicon_outline "document" stroke_width=2 class="size-4" %}
                    </button>
                {% else %}
                    <button class="btn btn-xs btn-dark-outline btn-success ms-2"
                            hx-post="{% url 'trips:note-check' note.id %}"
                            hx-target="#dialog"
                            hx-swap="innerHTML">
                        {% heroicon_outline "document-check" stroke_width=2 class="size-4" %}
                    </button>
                {% endif %}
                <button class="btn btn-xs btn-primary-outline ms-2"
                        hx-get="{% url 'trips:note-update' note.id %}"
                        hx-target="#dialog"
                        hx-swap="innerHTML"
                        @click="$dispatch('open-modal')">
                    {% heroicon_outline "pencil" stroke_width=2 class="size-4" %}
                </button>
                <button class="btn btn-xs btn-danger-outline ms-2"
                        hx-delete="{% url 'trips:note-delete' note.id %}"
                        hx-confirm="Are you sure you want to delete {{ link.url }}">
                    {% heroicon_outline "x-mark" stroke_width=2 class="size-4" %}
                </button>
            </li>
        {% endfor %}
    </ul>
    {% if request.htmx %}
        <div hx-swap-oob="innerHTML:#messages">{% include "includes/messages.html" %}</div>
    {% else %}
    {% endif %}
{% endpartialdef %}
</section>
{% endblock content %}
{% block script %}
    <script>
    {% if trip.places.all %}
        htmx.on("htmx:load", function(evt){
        if (evt.detail.elt.id == "map") {
          let map_bounds = JSON.parse(document.getElementById('map_bounds').textContent);
          let placesMap = createMap([map_bounds[0], map_bounds[1]]);
          let locations = JSON.parse(document.getElementById('location_json').textContent);

          let markerFeatureGroup = L.featureGroup().addTo(placesMap);

          for (let location of locations) {
            L.marker([ location.latitude, location.longitude]).addTo(markerFeatureGroup).bindPopup(location.name);
          }
        }
      });
    {% endif %}

    function resetInput() {
      let inputs = document.getElementsByClassName('select')
      Array.from(inputs).forEach((el) => el.selectedIndex = 0);
    }


    </script>
{% endblock script %}
