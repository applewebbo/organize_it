{% load i18n %}
<div class="flex items-center" x-data="themeSwitcher({{ user.profile.use_system_theme|yesno:'true,false' }})">
    <label class="swap swap-rotate">
        <input type="checkbox"
               class="theme-controller"
               x-model="isDark"
               @change="toggleTheme()" />

        <!-- Sun icon for light mode -->
        <i class="ph-bold ph-sun swap-off i-sm"></i>

        <!-- Moon icon for dark mode -->
        <i class="ph-bold ph-moon swap-on i-sm"></i>
    </label>
</div>

<script>
function themeSwitcher(useSystemTheme) {
    return {
        useSystemTheme: useSystemTheme,
        isDark: false,

        init() {
            this.isDark = this.getInitialTheme() === 'dark';
            this.applyTheme();
        },

        getInitialTheme() {
            // If user wants to follow system preference
            if (this.useSystemTheme) {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            // Otherwise check localStorage (manual selection)
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                return savedTheme;
            }

            // Default to system preference if nothing is set
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        },

        toggleTheme() {
            // Save to localStorage (works for both authenticated and non-authenticated users)
            this.applyTheme();
        },

        applyTheme() {
            const theme = this.isDark ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }
    }
}

// Apply theme on page load (before Alpine.js initializes)
(function() {
    const useSystemTheme = {{ user.profile.use_system_theme|default:'false'|yesno:'true,false' }};

    let theme;
    if (useSystemTheme) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    } else {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            theme = savedTheme;
        } else {
            theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
    }

    console.log('Setting theme:', theme, 'useSystemTheme:', useSystemTheme);
    document.documentElement.setAttribute('data-theme', theme);
    console.log('Current data-theme:', document.documentElement.getAttribute('data-theme'));
})();
</script>
